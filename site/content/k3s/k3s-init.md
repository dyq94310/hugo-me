---
title: "k3s ä½“éªŒï¼šä» docker-compose åˆ°è½»é‡çº§é›†ç¾¤"
date: 2025-09-17
---

# k3s ä½“éªŒï¼šä» docker-compose åˆ°è½»é‡çº§é›†ç¾¤

## é¡¹ç›®èƒŒæ™¯

æˆ‘ç°åœ¨æœ‰ä¸ƒå…«å°æœºå™¨ï¼ŒåŸæ¥å…¨éƒ¨ç”¨ `docker-compose` æ¥è·‘æœåŠ¡ã€‚
è™½ç„¶ `docker-compose` å·²ç»æ¯”ç›´æ¥æ•² `docker run` èˆ’æœå¾ˆå¤šï¼Œä½†å½“**æœºå™¨æ•°é‡ä¸€å¤š**ï¼Œé—®é¢˜å°±æ¥äº†ï¼š

* æ¯å°æœºå™¨ä¸€ä»½ `docker-compose.yaml`
* æƒ³æ”¹ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œè¦ç™»ä¸Šæ‰€æœ‰æœºå™¨æ”¹ä¸€åœˆ
* æƒ³çŸ¥é“æ•´ä¸ªç³»ç»Ÿâ€œç°åœ¨åˆ°åº•è·‘äº†ä»€ä¹ˆâ€ï¼Œéœ€è¦æŒ¨å°ç™»å½•

æˆ‘ç»™è‡ªå·±å®šäº†ä¸€ä¸ªç›®æ ‡ï¼š**ç”¨åŒä¸€å¥—æ–¹å¼ã€é›†ä¸­ç®¡ç†æ‰€æœ‰æœºå™¨ä¸Šçš„å®¹å™¨**ã€‚

å¯¹æˆ‘æ¥è¯´ï¼Œk3s æ»¡è¶³äº†ä¸¤ä¸ªæ ¸å¿ƒè¯‰æ±‚ï¼š

1. ç”¨ä¸€å¥— `kubectl` å‘½ä»¤ç®¡ç†æ‰€æœ‰å®¹å™¨
2. è‡ªèº«è¶³å¤Ÿè½»é‡ï¼Œé€‚åˆæˆ‘è¿™ç§â€œç©·äººå¤šæœºå°é›†ç¾¤â€

---

## k3s æ˜¯ä»€ä¹ˆï¼Ÿ

å®˜æ–¹ä¸€å¥è¯ï¼š**k3s æ˜¯é€šè¿‡ CNCF ä¸€è‡´æ€§è®¤è¯çš„è½»é‡çº§ Kubernetes å‘è¡Œç‰ˆï¼Œä¸“é—¨ä¸ºè¾¹ç¼˜è®¡ç®—å’Œ IoT åœºæ™¯è®¾è®¡ã€‚**

å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š

> k3s = â€œç¼©å°ç‰ˆã€ç˜¦èº«ç‰ˆçš„ Kubernetesâ€

ç‰¹ç‚¹ï¼š

* å•ä¸€äºŒè¿›åˆ¶ï¼Œå®‰è£…ç®€å•ï¼ˆåŸºæœ¬å°±æ˜¯ä¸€æ¡è„šæœ¬ï¼‰
* é»˜è®¤é›†æˆäº†ï¼š

  * `containerd` ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶
  * Flannel ä½œä¸ºé»˜è®¤ CNIï¼ˆå®¹å™¨ç½‘ç»œï¼‰
  * Local Path Provisioner ç­‰å®ç”¨ç»„ä»¶ï¼ˆå­˜å‚¨ï¼‰
* èµ„æºå ç”¨æ¯”å®Œæ•´ k8s å°å¾ˆå¤šï¼Œéå¸¸é€‚åˆï¼š

  * å®¶ç”¨å°é›†ç¾¤
  * è¾¹ç¼˜èŠ‚ç‚¹ã€æ ‘è“æ´¾
  * ä¸ªäººå­¦ä¹  / è½»é‡ç”Ÿäº§ç¯å¢ƒ

> è¿™é‡Œå°±ä¸å±•å¼€å®‰è£…å‘½ä»¤äº†ï¼Œç›´æ¥æœ â€œk3s installâ€ æˆ–è€…è®© LLM æŒ‰ä½ çš„ç³»ç»Ÿå†™å®‰è£…è„šæœ¬å³å¯ã€‚

![åŸç†å›¾](https://www.rancher.cn/k3s/images/how-it-works-k3s.svg)

---

## k3s ä¸ k8sï¼šå«æ³•å’Œæ¶æ„ä¸Šçš„ä¸€ç‚¹åŒºåˆ«

åœ¨ã€Œæ ‡å‡† Kubernetesã€é‡Œï¼Œæˆ‘ä»¬ä¹ æƒ¯è¯´ï¼š

* **Masterï¼ˆæ§åˆ¶å¹³é¢ï¼‰**
* **Workerï¼ˆå·¥ä½œèŠ‚ç‚¹ï¼‰**

åœ¨ k3s é‡Œå«æ³•ç•¥å¾®ä¸åŒï¼Œä½†è§’è‰²æ˜¯ä¸€æ ·çš„ï¼š

* **K3s Server â‰ˆ Master èŠ‚ç‚¹ï¼ˆæ§åˆ¶å¹³é¢ï¼‰**

  * è´Ÿè´£æ•´ä¸ªé›†ç¾¤çš„â€œè„‘å­â€ï¼šè°ƒåº¦ã€å­˜å‚¨çŠ¶æ€ã€å“åº” `kubectl` è¯·æ±‚
  * k3s æŠŠåŸæ¥ kube-apiserver / kube-scheduler ç­‰å¤šä¸ªè¿›ç¨‹ï¼Œ**æ‰“åŒ…æˆäº†ä¸€ä¸ªç²¾ç®€è¿›ç¨‹**

* **K3s Agent â‰ˆ Worker èŠ‚ç‚¹ï¼ˆå·¥ä½œèŠ‚ç‚¹ï¼‰**

  * çœŸæ­£è·‘ä½ çš„ Pod çš„åœ°æ–¹
  * å‘ Server æ³¨å†Œã€æ±‡æŠ¥çŠ¶æ€ï¼Œæ¥å—è°ƒåº¦

> æœ€å¤§çš„ä¸åŒåœ¨äºï¼š
> **k3s æŠŠå¤šè¿›ç¨‹çš„æ§åˆ¶å¹³é¢åˆæˆäº†â€œä¸€ä¸ªè¿›ç¨‹â€ï¼Œä»è€ŒèŠ‚çœäº†ä¸å°‘èµ„æºã€‚**

### Flannel æ˜¯å¹²å˜›çš„ï¼Ÿ

k3s é»˜è®¤ä¼šå¯ç”¨ä¸€ä¸ª CNI æ’ä»¶ï¼Œå¸¸è§å°±æ˜¯ **Flannel**ï¼š

* æ ¸å¿ƒä½œç”¨ï¼šç»™æ¯ä¸ª Pod åˆ†ä¸€ä¸ª IPï¼Œå»ºç«‹ä¸€ä¸ªâ€œè™šæ‹Ÿå†…ç½‘â€ï¼ˆOverlay Networkï¼‰
* å¸¸è§ç«¯å£ï¼š

  * VXLAN æ¨¡å¼ï¼šUDP **8472**
  * å¦‚æœæ¢æˆ WireGuard åç«¯ï¼Œåˆ™ä¼šç”¨ UDP **51820**

ä½ å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š

> Flannel = â€œè®©æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„ Pod åƒåœ¨åŒä¸€ç½‘æ®µä¸€æ ·äº’ç›¸è®¿é—®â€çš„ç½‘ç»œå±‚ã€‚

---

## k3s ä¸ Dockerï¼šé€ ç – vs ç›–æ¥¼

ä¸€å¥è¯æ€»ç»“ï¼š

* **Docker / docker-composeï¼š**
  åœ¨**æŸå°æœºå™¨ä¸Š**åšå®¹å™¨ç¼–æ’ï¼ˆå•æœºï¼‰
* **K3s / Kubernetesï¼š**
  åœ¨**ä¸€å †æœºå™¨ä¸Š**åšå®¹å™¨ç¼–æ’ï¼ˆé›†ç¾¤ï¼‰

### Docker çš„å…¸å‹æ¶æ„

```text
Docker Client (å‘½ä»¤è¡Œ)
   â†“
Docker Daemon (docker æœåŠ¡)
   â†“
containerd
   â†“
å®¹å™¨
```

### K3s çš„å…¸å‹æ¶æ„

```text
kubectl
   â†“
k3s Serverï¼ˆæ§åˆ¶å¹³é¢ï¼‰
   â†“
k3s Agentï¼ˆå„ä¸ªèŠ‚ç‚¹ï¼‰
   â†“
containerd
   â†“
Pod / å®¹å™¨
```

æ³¨æ„ï¼š**k3s é»˜è®¤å°±å¸¦äº† containerdï¼Œä¸éœ€è¦å†è£… Dockerã€‚**

### K3s vs Docker æ ¸å¿ƒå¯¹æ¯”è¡¨ï¼ˆä¿ç•™åŸæ„ï¼Œç¨å¾®æ•´ç†ä¸€ä¸‹ï¼‰

| å¯¹æ¯”ç»´åº¦            | Docker / docker-composeï¼ˆå®¹å™¨å¼•æ“ï¼‰                                                | K3sï¼ˆå®¹å™¨ç¼–æ’ç³»ç»Ÿï¼‰                                                                      |
| :-------------- | :--------------------------------------------------------------------------- | :------------------------------------------------------------------------------- |
| æ ¸å¿ƒæ¯”å–»            | **â€œåˆ¶é€ ç –å—â€**ï¼šæ‰“åŒ…ã€åˆ†å‘ã€è·‘åº”ç”¨å®¹å™¨                                                       | **â€œç›–æ¥¼æˆ¿â€**ï¼šç®¡ç†ä¸€å †æœºå™¨ä¸Šçš„å®¹å™¨ï¼Œè°ƒåº¦ã€æ‰©å®¹ã€è‡ªæ„ˆ                                                    |
| æ‰©å±•æ€§ (Scaling)   | **å•æœºä¸ºä¸»**ï¼šå¤šèµ·å‡ ä¸ªå‰¯æœ¬ = å¤šæ•²å‡ æ¬¡ `docker-compose up` æˆ–æ”¹ `scale`<br>è·¨æœºå™¨éœ€è¦è‡ªå·±æŠ˜è…¾ IP / è´Ÿè½½å‡è¡¡ | **é›†ç¾¤è‡ªåŠ¨æ‰©ç¼©å®¹**ï¼šæ”¹ä¸€ä¸‹ `replicas: 5`ï¼Œè°ƒåº¦å™¨è‡ªåŠ¨åˆ†é…åˆ°å¤šå°æœºå™¨ä¸Š                                      |
| æ•…éšœè‡ªæ„ˆ (Healing)  | å®¹å™¨çº§ï¼š`restart: always` èƒ½æ•‘çš„æ˜¯**å®¹å™¨è¿›ç¨‹å´©æºƒ**<br>æœºå™¨æŒ‚äº† = ä¸Šé¢çš„å®¹å™¨éƒ½æ²¡äº†                      | é›†ç¾¤çº§ï¼šæŸä¸ªèŠ‚ç‚¹å®•æœºï¼ŒK3s å‘ç°åä¼šæŠŠ Pod è‡ªåŠ¨è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹é‡å»º                                             |
| ç½‘ç»œ (Networking) | ä¸»è¦é ç«¯å£æ˜ å°„ï¼š`-p 8080:80`<br>è·¨æœºå™¨é€šä¿¡ä¾èµ–å®¿ä¸»æœº IP                                        | Pod é—´åœ¨åŒä¸€ä¸ªè™šæ‹Ÿç½‘æ®µï¼Œé€šè¿‡ CNIï¼ˆé»˜è®¤ Flannelï¼‰äº’é€š<br>ç”¨ Service / Ingress åšè´Ÿè½½å‡è¡¡å’Œæµé‡å…¥å£             |
| å­˜å‚¨ (Storage)    | å¤šä¸ºæœ¬åœ°æŒ‚è½½ï¼š`./data:/var/lib/...`<br>å®¹å™¨ä¸€æ—¦è¿ç§»åˆ°å¦ä¸€å°æœºå™¨ï¼Œæ•°æ®å°±ä¸åœ¨é‚£äº†                         | ç”¨ PersistentVolume / PersistentVolumeClaimï¼ˆPV/PVCï¼‰æŠ½è±¡å­˜å‚¨<br>å¯ä»¥å¯¹æ¥åˆ†å¸ƒå¼å­˜å‚¨ï¼ŒPod é£˜åˆ°å“ªæ•°æ®éƒ½è·Ÿç€ |
| åº•å±‚å…³ç³»            | åŒ…å« Docker CLI / Daemon / **containerd** / runc                               | k3s Server/Agent + **containerd** + runcï¼ˆé»˜è®¤ä¸ä¾èµ– Dockerï¼‰                           |
| å…¸å‹åœºæ™¯            | æœ¬åœ°å¼€å‘ã€å•æœºéƒ¨ç½²ã€å°å·¥å…·                                                                | å¾®æœåŠ¡ã€è¾¹ç¼˜é›†ç¾¤ã€å¤šæœºèµ„æºæ± ã€å¯¹é«˜å¯ç”¨æœ‰è¦æ±‚çš„åœºæ™¯                                                        |

---

## é›†ç¾¤å®‰è£…ä¸ç½‘ç»œè§„åˆ’ï¼ˆç®€ç•¥ç‰ˆï¼‰

### æ‹“æ‰‘è®¾å®šï¼ˆä¾‹å­ï¼‰

å‡è®¾ï¼š

* **Master / Server èŠ‚ç‚¹ï¼š** `47.1.1.1`
* **Worker / Agent èŠ‚ç‚¹ï¼š** `48.1.1.1`ï¼ˆå¯èƒ½åœ¨ NAT åï¼‰

å®é™…ç”¨çš„æ—¶å€™æ›¿æ¢æˆä½ è‡ªå·±çš„ IP å³å¯ã€‚

> æ‰€æœ‰èŠ‚ç‚¹ç›®å‰éƒ½å¸¦å…¬ç½‘ IPï¼Œåé¢è®¡åˆ’ç”¨ **Tailscale** ç»„å†…ç½‘ï¼Œè¿™é‡Œå…ˆæŒ‰å…¬ç½‘æ¥ã€‚

### å®‰å…¨ç»„ / firewalld æ”¾è¡Œå»ºè®®

> è¿™é‡Œåªæ˜¯å®è·µç»éªŒï¼Œä¸æ˜¯â€œå”¯ä¸€æ­£ç¡®ç­”æ¡ˆâ€ï¼Œå…·ä½“è¿˜è¦ç»“åˆä½ å…¬å¸ / äº‘å‚å•†å®‰å…¨ç­–ç•¥ã€‚

#### Masterï¼ˆ47.1.1.1ï¼‰ï¼š

* `TCP 6443`ï¼šå¯¹ Worker å¼€æ”¾ï¼ˆå¯ä»¥åªæ”¾è¡Œ Worker IP + ä½ è‡ªå·±çš„ç®¡ç† IPï¼‰

  * ç”¨é€”ï¼škube-apiserverï¼ŒWorker è¦æ¥â€œæ‰¾ç»„ç»‡â€
* `UDP 8472` æˆ– `UDP 51820`ï¼šå¯¹ Worker å¼€æ”¾

  * ç”¨é€”ï¼šFlannel / WireGuard çš„ Pod ç½‘ç»œ
* `TCP 10250`ï¼šåªå…è®¸é›†ç¾¤å†…ç›¸å…³èŠ‚ç‚¹è®¿é—®

  * ç”¨é€”ï¼škubelet APIï¼Œæ—¥å¿— / ç›‘æ§
* `TCP 80 / 443`ï¼šå¯¹å¤–å¼€æ”¾ï¼ˆå¦‚æœä½ æ‰“ç®—é€šè¿‡ Master æš´éœ²ä¸šåŠ¡ï¼‰
* `TCP 22`ï¼šåªå…è®¸ä½ è‡ªå·±çš„ç®¡ç† IPï¼ŒSSH ç™»å½•

#### Workerï¼ˆ48.1.1.1 / NAT åï¼‰ï¼š

* å¦‚æœ Worker åœ¨å®¶é‡Œ / NAT åï¼Œ**é€šå¸¸ä¸éœ€è¦å¯¹å¤–å¼€æ”¾ç«¯å£**ï¼Œåªè¦èƒ½ä¸»åŠ¨è®¿é—® Master å³å¯ã€‚
* å¦‚æœ Worker ä¹Ÿæ˜¯äº‘æœåŠ¡å™¨ï¼Œå»ºè®®ï¼š

  * `UDP 8472 / 51820`ï¼šå…è®¸ Master IP
  * `TCP 10250`ï¼šå…è®¸ Master IP
  * `TCP 80 / 443`ï¼šå¦‚æœä½ è®¡åˆ’è®©æµé‡ç›´æ¥æ‰“åˆ° Worker æ‰éœ€è¦å¼€æ”¾

---

## å®‰è£… kubectl å¹¶è¿æ¥é›†ç¾¤

`kubectl` æ˜¯ä½ å’Œé›†ç¾¤äº¤äº’çš„æ ¸å¿ƒå·¥å…·ï¼Œå¯ä»¥ç†è§£ä¸ºï¼š

> `kubectl` = â€œk8s / k3s çš„ git å‘½ä»¤è¡Œâ€

å¤§è‡´æµç¨‹ï¼š

1. åœ¨ **Windows / Linux** ä¸Šå®‰è£… `kubectl`
2. ä» k3s Server æ‹¿åˆ° `kubeconfig` æ–‡ä»¶ï¼ˆé€šå¸¸åœ¨ `/etc/rancher/k3s/k3s.yaml`ï¼‰
3. æŠŠè¯¥æ–‡ä»¶å¤åˆ¶åˆ°æœ¬æœº `~/.kube/config`ï¼Œæˆ–è€…é€šè¿‡ `KUBECONFIG` æŒ‡å®šè·¯å¾„
4. `kubectl get nodes` èƒ½çœ‹åˆ°é›†ç¾¤èŠ‚ç‚¹ï¼Œè¯´æ˜è”é€šæˆåŠŸ

å…·ä½“å®‰è£…å‘½ä»¤æ¯ä¸ªå¹³å°éƒ½ä¸å¤ªä¸€æ ·ï¼Œè¿™é‡Œä¸ç»†å†™ï¼Œå¯ä»¥ç›´æ¥é—® LLMï¼š

> ã€Œåœ¨ Windowsï¼ˆæˆ– Linuxï¼‰ä¸Šæ€ä¹ˆå®‰è£… kubectlï¼Œå¹¶è¿æ¥åˆ°å·²æœ‰çš„ k3s é›†ç¾¤ï¼Ÿã€

---

## ä» docker-compose è¿ç§»åˆ° k3s

å½“é›†ç¾¤æ­å¥½ä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹åšæ ¸å¿ƒå·¥ä½œï¼š**æŠŠåŸæ¥ä¸€å † docker-compose.yaml è¿ç§»åˆ° K3s ä¸Šã€‚**

### 1. æ ¸å¿ƒæ¦‚å¿µæ˜ å°„

å…ˆå»ºç«‹å¿ƒæ™ºå¯¹ç…§è¡¨ï¼š

| Docker Compose | Kubernetes / K3s                | è¯´æ˜                              |
| :------------- | :------------------------------ | :------------------------------ |
| `services:` ä¸€é¡¹ | **Deployment / StatefulSet**    | æ§åˆ¶å®¹å™¨å‰¯æœ¬æ•°ã€é•œåƒç‰ˆæœ¬ã€æ»šåŠ¨æ›´æ–°ç­–ç•¥             |
| `ports:`       | **Service**                     | æŠŠ Pod æš´éœ²å‡ºæ¥ï¼Œæä¾›ç¨³å®šçš„è®¿é—®å…¥å£            |
| `volumes:`     | **PV + PVC** æˆ– `hostPath`       | å­˜å‚¨æŠ½è±¡æ˜¯è¿ç§»é‡Œæœ€å®¹æ˜“è¸©å‘çš„                  |
| `environment:` | **ConfigMap / Secret**          | é…ç½®ä¸é•œåƒè§£è€¦ï¼Œæ•æ„Ÿä¿¡æ¯ç”¨ Secret            |
| `depends_on:`  | **InitContainer / å¥åº·æ£€æŸ¥ + é‡è¯•é€»è¾‘** | k8s æ²¡æœ‰ `depends_on`ï¼Œè¦è‡ªå·±è®¾è®¡â€œå°±ç»ªæ£€æµ‹â€ |
| `healthcheck:` | **Liveness / Readiness Probes** | å­˜æ´»æ¢é’ˆ + å°±ç»ªæ¢é’ˆï¼Œæ›´ç»†ç²’åº¦çš„å¥åº·ç®¡ç†           |

---

### 2. æœ€å¤§çš„å‘ï¼šå­˜å‚¨ï¼ˆVolumesï¼‰

åœ¨ docker-compose é‡Œï¼Œä½ å¯èƒ½ç»å¸¸è¿™æ ·å†™ï¼š

```yaml
volumes:
  - ./mysql-data:/var/lib/mysql
```

åœ¨å•æœºä¸Šæ²¡é—®é¢˜ï¼Œä½†åœ¨ **k3s é›†ç¾¤** ä¸­æœ‰ä¸€ä¸ªè‡´å‘½é—®é¢˜ï¼š

* Pod å¯èƒ½ä»Šå¤©è¢«è°ƒåº¦åœ¨èŠ‚ç‚¹ Aï¼Œæ˜å¤©åœ¨èŠ‚ç‚¹ B
* ä½ çš„ `./mysql-data` åªåœ¨æŸä¸€å°æœºå™¨ä¸Šå­˜åœ¨
* Pod é£˜è¿‡å»ä¹‹åï¼Œ**è¦ä¹ˆæ‰¾ä¸åˆ°æ•°æ®ï¼Œè¦ä¹ˆé‡æ–°åˆ›å»ºç©ºç›®å½•ï¼Œç›¸å½“äºâ€œä¸¢æ•°æ®â€**

è§£å†³æ–¹æ¡ˆï¼š

1. **Local Path Provisionerï¼ˆæ¨èï¼‰**

   * k3s è‡ªå¸¦çš„ StorageClass
   * ä½ åœ¨ YAML é‡Œåªéœ€è¦å†™ PVCï¼ŒçœŸæ­£çš„ç›®å½•ä½ç½®ç”± Provisioner åœ¨å¯¹åº”èŠ‚ç‚¹ä¸Šè‡ªåŠ¨åˆ›å»º
   * é€‚åˆ**æ— çŠ¶æ€ + ä¸€èˆ¬æ•°æ®**ï¼Œä¹Ÿå¯ä»¥ç”¨äºè½»é‡æ•°æ®åº“ç­‰

2. **HostPathï¼ˆæˆ‘ç›®å‰åœ¨ç”¨ï¼Œä½†è¦éå¸¸å°å¿ƒï¼‰**

   * ç›´æ¥æŠŠå®¿ä¸»æœºç›®å½•æš´éœ²ç»™ Pod
   * å¿…é¡»é…åˆï¼š

     * `nodeSelector` / `nodeAffinity`
     * ä¿è¯ Pod **æ°¸è¿œåªåœ¨è¿™å°æœºå™¨ä¸Šè·‘**
   * ä¸€æ—¦ Pod è¢«è°ƒåº¦åˆ°åˆ«çš„èŠ‚ç‚¹ï¼Œå°±ä¼šæ‰¾ä¸åˆ°è¿™æ¡è·¯å¾„äº†

> æˆ‘ç›®å‰åœ¨æŸäº›éœ€è¦â€œç›´æ¥è¯»æœ¬æœºç£ç›˜â€çš„åœºæ™¯ä¸‹ï¼Œç”¨çš„å°±æ˜¯ `hostPath + nodeSelector`ï¼Œä¸‹é¢çš„ä¾‹å­ä¹Ÿæ˜¯è¿™ç§å†™æ³•ã€‚

---

## ç¤ºä¾‹ï¼šä»¥ komari ä¸ºä¾‹çš„è¿ç§» Demo

### åŸæ¥çš„ docker-compose é…ç½®

```yaml
version: '3.8'
services:
  komari:
    image: ghcr.io/komari-monitor/komari:latest
    container_name: komari
    ports:
      - "25774:25774"
    volumes:
      - ./data:/app/data
    environment:
      ADMIN_USERNAME: username
      ADMIN_PASSWORD: pass
      KOMARI_ENABLE_CLOUDFLARED: "true"
      KOMARI_CLOUDFLARED_TOKEN: 123
    restart: unless-stopped
```

### è¿ç§»åˆ° k3sï¼šDeployment + Secret + hostPath

ä¸‹é¢è¿™ä¸ª Deployment å¤§éƒ¨åˆ†æ˜¯ç”± LLM å¸®æˆ‘ç”Ÿæˆï¼Œç„¶åæˆ‘å†æ‰‹å·¥è°ƒæ•´çš„ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: komari
  labels:
    app: komari
spec:
  replicas: 1
  selector:
    matchLabels:
      app: komari
  template:
    metadata:
      labels:
        app: komari
    spec:
      # [ç­–ç•¥] é’‰åœ¨ç‰¹å®šèŠ‚ç‚¹ï¼ˆä¾‹å¦‚ masterï¼‰ä¸Šï¼Œæ–¹ä¾¿è¯»æœ¬åœ°æ•°æ®
      nodeSelector:
        kubernetes.io/hostname: hosteons
      
      containers:
      - name: komari
        image: ghcr.io/komari-monitor/komari:latest
        ports:
        - containerPort: 25774

        # ç®¡ç†è´¦å·ï¼Œä» Secret é‡Œå–
        env:
        - name: ADMIN_USERNAME
          valueFrom:
            secretKeyRef:
              name: komari-secret
              key: ADMIN_USERNAME 
      
        - name: ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: komari-secret
              key: ADMIN_PASSWORD 
        
        # å¼€å¯å†…ç½® Tunnel
        - name: KOMARI_ENABLE_CLOUDFLARED
          value: "true"
        
        # Cloudflare Tokenï¼ŒåŒæ ·æ”¾åœ¨ Secret é‡Œ
        - name: KOMARI_CLOUDFLARED_TOKEN
          valueFrom:
            secretKeyRef:
              name: komari-secret
              key: KOMARI_CLOUDFLARED_TOKEN

        volumeMounts:
        - name: data-vol
          mountPath: /app/data
      
      volumes:
      - name: data-vol
        hostPath:
          # å®¿ä¸»æœºè·¯å¾„ï¼ˆå¯¹åº”åŸæ¥çš„ ./dataï¼‰
          path: /opt/k3s-data/komari
          type: DirectoryOrCreate
```

> å¦‚æœä½ å¸Œæœ›åƒ `25774:25774` é‚£æ ·å¯¹å¤–æš´éœ²ç«¯å£ï¼Œå¯ä»¥å†åŠ ä¸€ä¸ª Serviceï¼Œä¾‹å¦‚ NodePort æˆ– LoadBalancerã€‚è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œä¿ç•™åŸæœ‰æ€è·¯ã€‚

---

## å–„ç”¨ LLM åšè¿ç§»

æˆ‘ç°åœ¨çš„åšæ³•å¾ˆç®€å•ç²—æš´ï¼š**ç›´æ¥ä¸¢ç»™ LLM**ã€‚
> â€œLLM è´Ÿè´£ 80% çš„ä½“åŠ›æ´»ï¼Œäººç±»åªåšæœ€å 20% çš„å®¡æ ¸å’Œå–èˆâ€ï¼Œæ•ˆç‡æå‡éå¸¸æ˜æ˜¾ã€‚

---

## ç”¨ Git ç®¡ç† k3s é…ç½®

ç°åœ¨æˆ‘æ‰€æœ‰çš„ k3s é…ç½®æ–‡ä»¶éƒ½æ”¾åœ¨ä¸€ä¸ª Git ä»“åº“é‡Œï¼Œæœ€ç®€å•ç²—æš´ä½†éå¸¸ç®¡ç”¨ã€‚

* ğŸ“¦ Mixup é¡¹ç›®
  [https://github.com/dyq94310/Mixup/](https://github.com/dyq94310/Mixup/)

é‡Œé¢æ··äº† sing-boxã€ç›‘æ§ã€nodepass ç­‰èµ„æºï¼Œæœ‰ç‚¹ç±»ä¼¼â€œä¸ªäººç‰ˆå¯†é›ªé…ç½®ä»“â€ã€‚

å³ä¾¿ä¸åš GitOpsï¼Œåªåšåˆ°è¿™å‡ ç‚¹ä¹Ÿå¾ˆæœ‰ä»·å€¼ï¼š

1. **æ‰€æœ‰é›†ç¾¤é…ç½®éƒ½æœ‰ç‰ˆæœ¬è®°å½•**ï¼ˆæ”¹æŒ‚äº†å¯ä»¥å›æ»šï¼‰
2. **å¤šå°æœºå™¨ç»Ÿä¸€ä»ä»“åº“æ‹‰é…ç½®**ï¼Œå‡å°‘â€œæˆ‘è®°å¾—è¿™ä¸ªèŠ‚ç‚¹æ˜¯è¿™ä¹ˆé…ç½®çš„â€çš„é”™è§‰
3. æ–°å¢æœåŠ¡åªéœ€è¦ï¼š

   * å†™å¥½ YAML
   * æäº¤ Git
   * `kubectl apply -f` ä¸€ä¸‹

---

## sealed-secretsï¼šæŠŠæ•æ„Ÿä¿¡æ¯å®‰å…¨åœ°æ”¾è¿› Git

é›†ç¾¤é…ç½®æƒ³æ”¾è¿› Gitï¼Œä½†é‡Œé¢åˆæœ‰å„ç§å¯†ç ã€Tokenï¼Œè¿™å°±æ˜¯ **sealed-secrets** ç™»åœºçš„åœ°æ–¹ã€‚

ä¸€å¥è¯ï¼š

> **sealed-secrets = å¯ä»¥æ”¾å¿ƒæ¨åˆ° GitHub çš„åŠ å¯† Secret**

åŸºæœ¬åŸç†ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š

* åœ¨é›†ç¾¤é‡Œå®‰è£…ä¸€ä¸ª controllerï¼ˆSealedSecretsControllerï¼‰
* åœ¨æœ¬æœºå®‰è£… `kubeseal` CLI
* ä½ æœ¬åœ°å†™ä¸€ä¸ªæ™®é€šçš„ Secretï¼ˆæ˜æ–‡ï¼‰
* ç”¨ `kubeseal` åŠ å¯† -> å¾—åˆ°ä¸€ä¸ª `SealedSecret` å¯¹è±¡
* æäº¤åˆ° Git
* é›†ç¾¤é‡Œçš„ controller ä¼šç”¨è‡ªå·±çš„ç§é’¥è§£å¯†ï¼Œè‡ªåŠ¨ç”ŸæˆçœŸæ­£çš„ Secret

### å®‰è£… kubesealï¼ˆç•¥ï¼‰

è¿™é‡ŒåŒæ ·ä¸å†™è¯¦ç»†å‘½ä»¤ï¼Œå¯ä»¥æœï¼š

* â€œsealed-secrets controller installâ€
* â€œkubeseal installâ€

é€šå¸¸å°±æ˜¯ä¸€ä¸ª `kubectl apply -f ...` + å®‰è£… CLI äºŒè¿›åˆ¶ã€‚

### åŠ è§£å¯†æµç¨‹ç¤ºä¾‹

1. å†™ä¸€ä¸ªæ˜æ–‡ Secret æ¨¡æ¿ `plain.yaml`ï¼ˆ**æ³¨æ„ï¼šè¿™ä¸ªæ–‡ä»¶ä¸è¦æäº¤åˆ° Gitï¼**ï¼‰

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: komari-secret  # Secret åå­—
  namespace: default
type: Opaque
stringData:
  ADMIN_USERNAME: "username"
  ADMIN_PASSWORD: "pass"
  KOMARI_CLOUDFLARED_TOKEN: "eyJhIjoiZGY5ZWExO.....token"
```

2. ç”¨ `kubeseal` è½¬æˆå¯†æ–‡ `sealed-secret.yaml`ï¼š

```bash
kubeseal --format=yaml < plain.yaml > sealed-secret.yaml
```

å¾—åˆ°çš„ `sealed-secret.yaml` ä¼šæ˜¯ä¸€ä¸ª `kind: SealedSecret` çš„å¯¹è±¡ï¼Œé‡Œé¢çš„å€¼å·²ç»è¢«åŠ å¯†ï¼Œå¯ä»¥å®‰å…¨æäº¤åˆ° Gitã€‚

3. åœ¨ Deployment é‡Œå¼•ç”¨è¿™ä¸ª Secretï¼ˆè·Ÿæ™®é€š Secret ç”¨æ³•ä¸€æ ·ï¼‰ï¼š

```yaml
        - name: KOMARI_CLOUDFLARED_TOKEN 
          valueFrom:
            secretKeyRef:
              name: komari-secret          # Secret å
              key: KOMARI_CLOUDFLARED_TOKEN  # é”®å
```

4. æäº¤ `sealed-secret.yaml`ï¼Œåœ¨é›†ç¾¤é‡Œæ‰§è¡Œï¼š

```bash
kubectl apply -f sealed-secret.yaml
kubectl apply -f komari-deploy.yaml
```

å½“ä½ é‡æ–°éƒ¨ç½²åº”ç”¨æ—¶ï¼Œé›†ç¾¤ä¼šè‡ªåŠ¨ä» SealedSecret è¿˜åŸå‡ºçœŸæ­£çš„ Secretï¼Œç„¶å Pod å°±èƒ½æ­£å¸¸æ‹‰åˆ°è¿™äº›æ•æ„Ÿé…ç½®ã€‚

---

## å°ç»“ & ä¸€äº›å»ºè®®

å¦‚æœä½ ç°åœ¨ä¹Ÿåœ¨ç”¨ docker-compose ç®¡ N å°æœºå™¨ï¼Œæˆ‘çš„æ•´ä½“ä½“éªŒæ˜¯ï¼š

* **ä¸€æ­¥åˆ°ä½ä¸Šå®Œæ•´ k8s å¾ˆé‡ï¼Œk3s æ˜¯ä¸€ä¸ªä¸é”™çš„è¿‡æ¸¡ç”šè‡³ç»ˆç‚¹**
* æŠŠé…ç½®ä»â€œæ•£è½åœ¨æ¯å°æœºå™¨â€è¿›åŒ–åˆ°â€œé›†ä¸­ Git ç®¡ç†â€ï¼Œå¿ƒæ€ä¼šå¥½å¾ˆå¤š
* è¿ç§»æ—¶ï¼š

  1. å…ˆä»**æ— çŠ¶æ€**æœåŠ¡å¼€å§‹è¿ç§»ï¼ˆStatelessï¼‰
  2. å­˜å‚¨éƒ¨åˆ†è¦æ ¼å¤–å°å¿ƒï¼Œä¼˜å…ˆäº†è§£ PVC / StorageClass
  3. æ•æ„Ÿä¿¡æ¯å°½é‡ä¸€å¼€å§‹å°±ç”¨ Secret + sealed-secrets
* å¤§é‡é‡å¤æ€§ YAML ä¸å¿…è‡ªå·±æ‰‹å†™ï¼Œ**å¤§èƒ†äº¤ç»™ LLM èµ·è‰**ï¼Œåªè¦ä½ æœ€åèƒ½çœ‹æ‡‚å®ƒç”Ÿæˆçš„å†…å®¹
